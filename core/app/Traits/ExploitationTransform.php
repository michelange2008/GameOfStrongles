<?php
namespace App\Traits;

use App\Factory\ExploitationFactory;

trait ExploitationTransform
{
  public function transform(ExploitationFactory $exploitation)
  {
    // creation s'un tableau de strongles dans le troupeau
    $strongles = [];
    foreach ($exploitation->troupeau()->infestation() as $key => $ver) {
      $strongle['age'] = $ver->age();
      $strongle['pathogen'] = $ver->pathogen();
      $strongle['etat'] = $ver->etat();
      $strongles['strongle_'.$key] = $strongle;
    }
    // lecture de chaque dessinparcelle et de chaque infestation
    $foncier = [];
    $pature = [];
    foreach ($exploitation->dessinparcellaire()->listeDessinparcelles() as $key => $dessinparcelle) {
      if($dessinparcelle->parcelle()->infestation()->count() > 0)
      {
        $infestation = [];
        foreach($dessinparcelle->parcelle()->infestation() as $clef => $ver)
        {
          $strongle['age'] = $ver->age();
          $strongle['pathogen'] = $ver->pathogen();
          $strongle['etat'] = $ver->etat();
          $strongle['localisation'] = $ver->localisation();
          $infestation['strongle_'.$clef] = $strongle;
        }
      }
      $pature = [
        'id' => 'pature_'.$dessinparcelle->id(),
        'nom' => $dessinparcelle->parcelle()->nom(),
        'superficie' => $dessinparcelle->parcelle()->superficie(),
        'parcelles' => [
          'parcelle_'.$dessinparcelle->id().'_0' => [
            'id' => 'parcelle_'.$dessinparcelle->id().'_0',
            'proportion' => 100,
            'contaminant' => $dessinparcelle->parcelle()->contaminant(),
            'infestation' => $infestation,
          ]
        ]
      ];
      $foncier['pature_'.$dessinparcelle->id()] = $pature;
    }
    // récupération des $dates
    $dates = $exploitation->dates();
    $troupeau = [
      'espece' => $exploitation->troupeau()->espece(),
      'taille' => $exploitation->troupeau()->taille(),
      'sensibilite' => $exploitation->troupeau()->sensibilite(),
      'infestation' => $strongles,
    ];
    $exploitationJson = [
      'troupeau' => $troupeau,
      'foncier' => $foncier,
      'dates' => $dates
    ];

    return $exploitationJson;
  }

}
